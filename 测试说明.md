# 排班系统测试说明

## 测试结果总结

✅ **后端编译测试：PASSED**
- 所有Java文件编译成功
- 没有编译错误
- 依赖项正常

### 修复的问题

1. ✅ **DoctorLeaveService.java** - 添加了缺失的 `ScheduleException` 导入
2. ✅ **Result.java** - 添加了静态工厂方法（success(), error()）
3. ✅ **DoctorLeaveServiceImpl.java** - 修复了Long到int的类型转换问题

---

## 数据库初始化步骤

### 1. 执行数据库脚本

```bash
# 连接到MySQL数据库
mysql -u root -p

# 创建数据库（如果还未创建）
CREATE DATABASE IF NOT EXISTS hospital DEFAULT CHARSET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 使用数据库
USE hospital;

# 执行建表脚本
SOURCE /path/to/backend/src/main/resources/db/hospital.sql;

# 执行测试数据脚本（可选）
SOURCE /path/to/backend/src/main/resources/db/hospital_data.sql;
```

### 2. 验证表结构

```sql
-- 查看排班相关表
SHOW TABLES LIKE '%schedule%';
SHOW TABLES LIKE '%doctor%';

-- 验证schedule_exceptions表结构（包含新增字段）
DESC schedule_exceptions;

-- 应该看到以下字段：
-- - adjusted_date (新增)
-- - status (新增)
```

---

## 后端启动测试

### 1. 配置数据库连接

检查 `backend/src/main/resources/application.yml` 或 `application.properties`：

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/hospital?useSSL=false&serverTimezone=UTC
    username: your_username
    password: your_password
```

### 2. 启动后端

```bash
cd backend
mvn spring-boot:run
```

### 3. 验证启动成功

查看日志，应该看到：
```
Tomcat started on port(s): 8080
Started BackendApplication in X seconds
```

---

## API接口测试

### 测试工具
- Postman
- curl
- Apifox

### 测试用例示例

#### 1. 创建排班（管理员）

```http
POST http://localhost:8080/api/admin/schedules/create
Content-Type: application/json

{
  "doctorId": 1,
  "deptId": 1,
  "roomId": 1,
  "startDate": "2025-11-01",
  "endDate": "2025-11-07",
  "weekDays": [1, 3, 5],
  "timeSlots": [0, 1],
  "appointmentTypeId": 1,
  "maxSlots": 10
}
```

预期响应：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": null
}
```

#### 2. 查询排班列表

```http
GET http://localhost:8080/api/admin/schedules/list?startDate=2025-11-01&endDate=2025-11-30
```

预期响应：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": [
    {
      "scheduleId": 1,
      "doctorName": "张医生",
      "deptName": "内科",
      "workDate": "2025-11-01",
      "timeSlot": 0,
      "timeSlotName": "上午",
      "maxSlots": 10,
      "availableSlots": 10,
      "status": "open"
    }
  ]
}
```

#### 3. 医生查看排班

```http
GET http://localhost:8080/api/doctor/schedules/my?doctorId=1&startDate=2025-11-01&endDate=2025-11-30
```

#### 4. 医生申请请假

```http
POST http://localhost:8080/api/doctor/schedules/leave/apply
Content-Type: application/json

{
  "doctorId": 1,
  "fromDate": "2025-11-10",
  "toDate": "2025-11-12",
  "reason": "个人事务"
}
```

#### 5. 管理员审批请假

```http
PUT http://localhost:8080/api/admin/leaves/review
Content-Type: application/json

{
  "leaveId": 1,
  "action": "approve",
  "reviewedBy": 1
}
```

---

## 前端测试

### 1. 安装依赖

```bash
cd frontend
npm install
```

### 2. 配置API地址

检查 `frontend/src/main.js` 或相关配置文件中的axios baseURL。

### 3. 启动前端

```bash
npm run dev
```

### 4. 访问页面

打开浏览器访问：`http://localhost:5173` (或显示的端口)

### 5. 测试页面功能

#### 管理员端测试
- 访问排班管理页面 `/admin/schedules`
- 测试批量创建排班
- 测试修改排班
- 测试停诊功能
- 测试临时加号
- 访问请假审批页面 `/admin/leaves`
- 测试审批请假和调班

#### 医生端测试
- 访问我的排班页面 `/doctor/schedules`
- 查看日历视图
- 测试申请请假
- 测试申请调班
- 测试临时加号
- 查看请假历史

---

## 测试数据准备

### 基础数据插入

```sql
-- 插入测试科室
INSERT INTO departments (dept_name, building, floor, room, description) VALUES
('内科', '东楼', 2, '201-210', '内科诊室'),
('外科', '东楼', 3, '301-310', '外科诊室');

-- 插入测试用户
INSERT INTO users (username, password, gender, phone, email, role_type, status) VALUES
('张医生', 'password123', 'M', '13800138001', 'zhang@hospital.com', 'doctor', 'verified'),
('管理员', 'admin123', 'M', '13800138000', 'admin@hospital.com', 'admin', 'verified');

-- 插入测试医生
INSERT INTO doctors (user_id, dept_id, title, bio, status) VALUES
(1, 1, '主任医师', '内科专家', 'active');

-- 插入测试诊室
INSERT INTO consultation_rooms (dept_id, room_name, building, floor, description) VALUES
(1, '201', '东楼', 2, '内科1号诊室'),
(1, '202', '东楼', 2, '内科2号诊室');

-- 插入号别类型
INSERT INTO appointment_types (type_key, type_name, fee_amount, description) VALUES
('normal', '普通号', 10.00, '普通门诊'),
('expert', '专家号', 50.00, '专家门诊'),
('special', '特需号', 100.00, '特需门诊');
```

---

## 常见问题排查

### 1. 编译错误

**问题**: Result类没有success()方法
**解决**: 已在Result.java中添加静态工厂方法

**问题**: Long无法转换为int
**解决**: 已使用Math.toIntExact()进行安全转换

### 2. 数据库连接失败

**问题**: 找不到数据库
**解决**: 确保MySQL服务启动，数据库已创建

**问题**: 认证失败
**解决**: 检查application.yml中的用户名密码

### 3. 前端无法连接后端

**问题**: CORS错误
**解决**: Controller已添加@CrossOrigin注解

**问题**: 404错误
**解决**: 检查API路径是否正确，后端是否启动

---

## 性能测试建议

### 1. 批量创建排班性能

测试创建1000条排班记录的耗时：
```
日期范围: 30天
每天: 3个时段
医生数: 10人
预期: 900条记录
```

### 2. 查询性能

测试查询大量排班数据：
```sql
-- 添加索引优化
CREATE INDEX idx_schedule_date ON schedules(work_date);
CREATE INDEX idx_schedule_doctor ON schedules(doctor_id, work_date);
```

### 3. 并发测试

使用JMeter或ab进行并发请求测试：
```bash
ab -n 1000 -c 10 http://localhost:8080/api/admin/schedules/list
```

---

## 下一步工作

### 必须完成（运行必需）
- [ ] 插入基础测试数据（科室、医生、诊室、号别）
- [ ] 配置数据库连接
- [ ] 添加路由配置（将新页面加入前端路由）

### 可选增强
- [ ] 实现科室列表API
- [ ] 实现医生列表API
- [ ] 实现诊室列表API
- [ ] 实现号别类型列表API
- [ ] 集成登录态获取当前用户ID
- [ ] 添加邮件通知功能
- [ ] 添加短信通知功能

### 代码优化
- [ ] 添加参数校验（@Valid、@NotNull等）
- [ ] 添加单元测试
- [ ] 添加集成测试
- [ ] 优化错误处理和异常提示
- [ ] 添加日志记录

---

## 测试检查清单

### 后端测试
- [x] 代码编译通过
- [ ] 数据库脚本执行成功
- [ ] 应用启动成功
- [ ] API接口正常响应
- [ ] 数据插入正常
- [ ] 数据查询正常
- [ ] 事务回滚正常
- [ ] 异常处理正常

### 前端测试
- [ ] 依赖安装成功
- [ ] 应用启动成功
- [ ] 页面渲染正常
- [ ] API调用成功
- [ ] 表单验证正常
- [ ] 对话框交互正常
- [ ] 数据展示正常

### 业务流程测试
- [ ] 创建排班流程
- [ ] 修改排班流程
- [ ] 停诊流程
- [ ] 临时加号流程
- [ ] 请假申请和审批流程
- [ ] 调班申请和审批流程
- [ ] 冲突检测功能
- [ ] 患者影响处理流程

---

## 总结

**已完成**：
✅ 后端代码编写完成
✅ 前端页面编写完成
✅ 代码编译测试通过
✅ 修复所有编译错误

**待测试**：
⏳ 数据库脚本执行
⏳ 后端API接口测试
⏳ 前端页面功能测试
⏳ 完整业务流程测试

**建议**：
1. 先执行数据库脚本，插入测试数据
2. 启动后端，使用Postman测试API
3. 启动前端，测试页面交互
4. 进行完整的业务流程测试

排班系统代码实现完毕，编译通过，可以开始运行测试！🎉
